/** streamdata-js-sdk - Javascript SDK for Streamdata.io
 * @version v1.0.1-SNAPSHOT
 * rev: a7437cb417bd5dcce7f92cbc50e4fc6eb9b3d249
 */
(function(b){function d(g,a,c){var b=window.location.origin;this.cancelable=this.cancelBubble=this.bubbles=!1;this.data=a||null;this.origin=b||"";this.lastEventId=c||"";this.type=g||"message"}if(!b.EventSource||b.ma){var e=(b.ma||"")+"EventSource",f=function(g,a){if(!g||"string"!=typeof g)throw new SyntaxError("Not enough arguments");this.URL=g;this.Ba(a);var c=this;setTimeout(function(){c.$()},0)};f.prototype={CONNECTING:0,OPEN:1,CLOSED:2,U:{loggingEnabled:!1,loggingPrefix:"eventsource",interval:500,
bufferSizeLimit:1048576,G:3E5,B:{},ca:{Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"}},Ba:function(g){var a=this.U,c;for(c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);for(c in g)c in a&&g.hasOwnProperty(c)&&(this[c]=g[c]);if("undefined"===typeof console||"undefined"===typeof console.log)this.loggingEnabled=!1},log:function(g){this.loggingEnabled&&console.log("["+this.loggingPrefix+"]:"+g)},$:function(){try{this.readyState!=this.CLOSED&&(this.T(),this.readyState=
this.CONNECTING,this.cursor=0,this.cache="",this.h=new this.s(this),this.aa())}catch(g){this.log("An error occured during polling."),this.dispatchEvent("error",{type:"error",data:g.message})}},C:function(g){var a=this;a.readyState=a.CONNECTING;a.dispatchEvent("error",{type:"error",data:"Reconnecting "});this.v=setTimeout(function(){a.$()},g||0)},T:function(){this.log("evs cleaning up");this.v&&(clearInterval(this.v),this.v=null);this.l&&(clearInterval(this.l),this.l=null);this.h&&(this.h.abort(),
this.h=null)},aa:function(){if(this.G){this.l&&clearInterval(this.l);var g=this;this.l=setTimeout(function(){g.log("Timeout! silentTImeout:"+g.G);g.C()},this.G)}},close:function(){this.readyState=this.CLOSED;this.log("Closing connection.");this.T()},D:function(){var g=this.h;if(g.Z()&&!g.X()){this.aa();this.readyState==this.CONNECTING&&(this.readyState=this.OPEN,this.dispatchEvent("open",{type:"open"}));var a=g.W();a.length>this.bufferSizeLimit&&(this.log("buffer length > bufferSizeLimit"),this.C());
0==this.cursor&&0<a.length&&"\ufeff"==a.substring(0,1)&&(this.cursor=1);var c=this.sa(a);c[0]>=this.cursor&&(c=c[1],this.za(a.substring(this.cursor,c)),this.cursor=c);g.Y()&&(this.log("request.isDone(). reopening the connection"),this.C(this.interval))}else this.readyState!==this.CLOSED&&(this.log("this.readyState !== this.CLOSED"),this.C(this.interval))},za:function(g){g=this.cache+this.ta(g);g=g.split("\n\n");var a,c,b,f,e;for(a=0;a<g.length-1;a++){b="message";f=[];parts=g[a].split("\n");for(c=
0;c<parts.length;c++)e=this.Ca(parts[c]),0==e.indexOf("event")?b=e.replace(/event:?\s*/,""):0==e.indexOf("retry")?(e=parseInt(e.replace(/retry:?\s*/,"")),isNaN(e)||(this.interval=e)):0==e.indexOf("data")?f.push(e.replace(/data:?\s*/,"")):0==e.indexOf("id:")?this.lastEventId=e.replace(/id:?\s*/,""):0==e.indexOf("id")&&(this.lastEventId=null);f.length&&this.dispatchEvent(b,new d(b,f.join("\n"),this.lastEventId))}this.cache=g[g.length-1]},dispatchEvent:function(a,h){var c=this["_"+a+"Handlers"];if(c)for(var b=
0;b<c.length;b++)c[b].call(this,h);this["on"+a]&&this["on"+a].call(this,h)},addEventListener:function(a,h){this["_"+a+"Handlers"]||(this["_"+a+"Handlers"]=[]);this["_"+a+"Handlers"].push(h)},v:null,h:null,lastEventId:null,cache:"",cursor:0,readyState:0,ba:function(a,h){var c=[];if(h){var b,d,e=encodeURIComponent;for(b in h)h.hasOwnProperty(b)&&(d=e(b)+"="+e(h[b]),c.push(d))}return 0<c.length?-1==a.indexOf("?")?a+"?"+c.join("&"):a+"&"+c.join("&"):a},sa:function(a){var b=a.lastIndexOf("\n\n"),c=a.lastIndexOf("\r\r");
a=a.lastIndexOf("\r\n\r\n");return a>Math.max(b,c)?[a,a+4]:[Math.max(b,c),Math.max(b,c)+2]},Ca:function(a){return a.replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")},ta:function(a){return a.replace(/\r\n|\r/g,"\n")}};if(window.XDomainRequest&&window.XMLHttpRequest&&void 0===(new XMLHttpRequest).responseType){f.isPolyfill="IE_8-9";var a=f.prototype.U;a.ca=null;a.B.evs_preamble=2056;f.prototype.s=function(a){this.c=request=new XDomainRequest;request.onprogress=function(){request.O=!0;a.D()};request.onload=
function(){this.K=!0;a.D()};request.onerror=function(){this.g=!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest error"})};request.ontimeout=function(){this.g=!0;a.readyState=a.CLOSED;a.dispatchEvent("error",{type:"error",data:"XDomainRequest timed out"})};var b={};if(a.B){var c=a.B,d;for(d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);a.lastEventId&&(b.evs_last_event_id=a.lastEventId)}request.open("GET",a.ba(a.URL,b));request.send()};f.prototype.s.prototype={c:null,O:!1,
K:!1,g:!1,Z:function(){return this.c.O},Y:function(){return this.c.K},X:function(){return this.c.g},W:function(){var a="";try{a=this.c.responseText||""}catch(b){}return a},abort:function(){this.c&&this.c.abort()}}}else f.isPolyfill="XHR",f.prototype.s=function(a){this.c=request=new XMLHttpRequest;a.h=this;request.onreadystatechange=function(){1<request.readyState&&a.readyState!=a.CLOSED&&(200==request.status||300<=request.status&&400>request.status?a.D():(request.g=!0,a.readyState=a.CLOSED,a.dispatchEvent("error",
{type:"error",data:"The server responded with "+request.status}),a.close()))};request.onprogress=function(){};request.open("GET",a.ba(a.URL,a.B),!0);var b=a.ca,c;for(c in b)b.hasOwnProperty(c)&&request.setRequestHeader(c,b[c]);a.lastEventId&&request.setRequestHeader("Last-Event-Id",a.lastEventId);request.send()},f.prototype.s.prototype={c:null,g:!1,Z:function(){return 2<=this.c.readyState},Y:function(){return 4==this.c.readyState},X:function(){return this.g||400<=this.c.status},W:function(){var a=
"";try{a=this.c.responseText||""}catch(b){}return a},abort:function(){this.c&&this.c.abort()}};b[e]=f}})(this);var Exporter={m:function(b,d,e){d=d.split(".");for(var f=0;f<d.length-1;f++)b=b[d[f]];this.a(b,d[d.length-1],e)},a:function(b,d,e){b[d]=e}};var Logger=function(){function b(b,a){return b.replace(/{(\d+)}/g,function(b,h){var c;if(a[h]&&"object"===typeof a[h]&&a[h]instanceof Error)try{c=a[h].message,a[h].stack&&d.error(a[h].stack)}catch(e){c=a[h]}else if(a[h]&&"object"===typeof a[h])try{a[h].toString!==Object.prototype.toString?c=a[h].toString():c=JSON.stringify(a[h])}catch(f){c=a[h]}else a[h]&&"function"===typeof a[h]?c="function":c=a[h]?a[h]:b;c=""+c;return c.substring(0,Math.min(500,c.length))})}var d=window.console,e=2;return{da:3,
ea:2,fa:1,ERROR:0,Aa:function(b){e=b},debug:function(){3<=e&&d&&d.log&&d.log(b(arguments[0],Array.prototype.slice.call(arguments,1)))},info:function(){2<=e&&d&&d.info&&d.info(b(arguments[0],Array.prototype.slice.call(arguments,1)))},warn:function(){1<=e&&d&&d.warn&&d.warn(b(arguments[0],Array.prototype.slice.call(arguments,1)))},error:function(){0<=e&&d&&d.error&&d.error(b(arguments[0],Array.prototype.slice.call(arguments,1)))}}}();var Preconditions=function(b){return{b:function(b,e){if("undefined"===typeof b||null===b){if(e)throw Error(e);throw Error("value cannot be null");}return b},m:function(d,e){this.b(d,"functionName cannot be null");this.b(e,"message cannot be null");b.warn("Deprecated: function '{0}' is deprecated because '{1}'.",d,e)},S:function(b,e){if(!b){if(e)throw Error(e);throw Error("expression is not valid");}},A:function(b,e){if(!b){if(e)throw Error(e);throw Error("expression is not valid");}}}}(Logger);function Listeners(b){Preconditions.b(b,"bind cannot be null");this.ga=b;this.j=[]}
Listeners.prototype={o:function(){for(var b=this.j.slice(),d=0,e=b.length;d<e;d++)try{var f=b[d];f&&f.apply(this.ga,arguments)}catch(a){Logger.error("Unable to forward event: {0}",a)}},add:function(b){Preconditions.b(b,"listener cannot be null");Preconditions.S(-1==this.j.indexOf(b),"listener already exists");this.j.push(b)},remove:function(b){Preconditions.b(b,"listener cannot be null");b=this.j.indexOf(b);Preconditions.S(0<=b,"listener not exists");this.j.splice(b,1)}};function StreamdataEventSource(b,d,e,f){Preconditions.b(b,"url cannot be null.");Preconditions.b(d,"appToken cannot be null.");Preconditions.A(null===f||void 0===f||f.hasOwnProperty("signUrl"),"authStrategy does not implement signUrl() function.");e=e||[];f=void 0===f?null:f;var a=this;a.streamdataConfig={PROTOCOL:"https://",HOST:"streamdata.motwin.net",PORT:""};a.f=null;a.i=!1;a.F=b;a.M=new Listeners(a);a.H=new Listeners(a);a.N=new Listeners(a);a.J=new Listeners(a);a.L=new Listeners(a);a.na=e;a.I=
{type:"UnknownError",status:1E3,message:"An error occured. Please check your console logs for more details.",source:"server"};a.ha=1048576;a.oa=!1;a.w={bufferSizeLimit:a.ha,loggingEnabled:a.oa};a.open=function(){Preconditions.b(a.F,"url cannot be null");a.close();var b=a.la(a.F,a.na);b&&(a.f=a.u()?new EventSource(b,a.w):new EventSource(b),a.f.addEventListener("open",function(b){Logger.debug("SSE Stream Opened to "+a.F+"event: "+JSON.stringify(b));a.i=!0;a.M.o()}),a.f.addEventListener("error",function(b){Logger.debug("Error with SSE at "+
b+": closing the stream.");a.f.close();a.i=!1;a.J.o(a.ia(b))}),a.f.addEventListener("data",function(b){Logger.debug("Received data:"+b.data);a.H.o(JSON.parse(b.data))}),a.f.addEventListener("patch",function(b){Logger.debug("Received patch:"+b.data);a.N.o(JSON.parse(b.data))}),a.f.addEventListener("monitor",function(b){Logger.debug("Received monitor:"+b.data);a.L.o(JSON.parse(b.data))}));return this};a.close=function(){a.i&&null!==a.f&&(Logger.info("Closing the SSE Stream."),a.f.close(),a.i=!1);return this};
a.la=function(b,e){Preconditions.b(b,"url cannot be null");e=e||[];var c=document.createElement("a");c.href=b;var d=/\/\/(.*@)/g.exec(b),d=d?d=d[1]:"",c=c.protocol+"//"+d+c.hostname+("0"!=c.port&&""!=c.port&&"80"!=c.port&&"443"!=c.port?":"+c.port:"")+(0==c.pathname.indexOf("/")?"":"/")+c.pathname+c.search,c=null===f?c:f.signUrl(c),d=a.ka(e),k="";0<d.length&&(k=document.createElement("a"),k.href=c,k=(-1===k.search.indexOf("?")?"?":"&")+d.join("&"));c=a.streamdataConfig.PROTOCOL+a.streamdataConfig.HOST+
(a.ra(a.streamdataConfig.PORT)?"":":")+a.streamdataConfig.PORT+"/"+c+k;Logger.debug("converted url :"+c);return c};a.ka=function(b){b=b||[];b=a.ja(b);b.push("X-Sd-Token="+encodeURIComponent(d));return b};a.ja=function(a){a=a||[];return a.map(function(a){return"X-Sd-Header="+encodeURIComponent(a)})};a.ia=function(b){Preconditions.b(b,"event cannot be null");var d=a.I;try{var c=JSON.parse(b.data);d.type=c.cause;d.message=c.message;d.status=c.status}catch(e){d=a.I}d.source="server";console.log(JSON.stringify(d));
return new StreamdataError(d.type,d.message,d.status,d.source,!0)};a.ra=function(a){return!a||0===a.length};a.setBufferSizeLimit=function(b){Preconditions.b(b,"buffer size cannot be null");Preconditions.A(a.u(),"Buffer size cannot be set on native EventSource.");a.w.bufferSizeLimit=b};a.enableLogging=function(){Preconditions.A(a.u(),"logging cannot be enabled on native EventSource.");a.w.loggingEnabled=!0};a.disableLogging=function(){Preconditions.A(a.u(),"logging cannot be disabled on native EventSource.");
a.w.loggingEnabled=!1};a.u=function(){switch(EventSource.isPolyfill){case void 0:return!1;case "XHR":return!0;case "IE_8-9":return!0;default:return!1}}}
StreamdataEventSource.prototype={xa:function(b){Preconditions.b(b,"listener cannot be null");this.M.add(b);return this},va:function(b){Preconditions.b(b,"listener cannot be null");this.J.add(b);return this},ua:function(b){Preconditions.b(b,"listener cannot be null");this.H.add(b);return this},ya:function(b){Preconditions.b(b,"listener cannot be null");this.N.add(b);return this},wa:function(b){Preconditions.b(b,"listener cannot be null");this.L.add(b);return this},qa:function(){return this.i}};function StreamdataError(b,d,e,f,a){this.m=f;this.V=b;this.P=d;this.pa=a||!1;this.R=e;Exporter.a(this,"source",this.m);Exporter.a(this,"type",this.V);Exporter.a(this,"message",this.P);Exporter.a(this,"status",this.R)}StreamdataError.prototype={isFatal:function(){return this.pa},isServer:function(){return"server"==this.m},isClient:function(){return"client"==this.m},getMessage:function(){return this.P},getStatus:function(){return this.R},getType:function(){return this.V}};var streamdataio=new function(){};Exporter.a(streamdataio,"Logger",Logger);Exporter.a(Logger,"DEBUG",Logger.da);Exporter.a(Logger,"INFO",Logger.ea);Exporter.a(Logger,"WARN",Logger.fa);Exporter.a(Logger,"ERROR",Logger.ERROR);Exporter.a(Logger,"setLevel",Logger.Aa);Exporter.a(Logger,"debug",Logger.debug);Exporter.a(Logger,"info",Logger.info);Exporter.a(Logger,"warn",Logger.warn);Exporter.a(Logger,"error",Logger.error);
Exporter.a(streamdataio,"createEventSource",function(b,d,e,f){Preconditions.b(b,"url cannot be null");d=d||[];f=f||null;0!=b.lastIndexOf("http://",0)&&0!=b.lastIndexOf("https://",0)&&(b="http://"+b,Logger.warn("url has no default protocol defined. Add http:// as a default protocol."));return new StreamdataEventSource(b,d,e,f)});Exporter.a(StreamdataError.prototype,"isFatal",StreamdataError.prototype.isFatal);Exporter.a(StreamdataError.prototype,"isServer",StreamdataError.prototype.isServer);
Exporter.a(StreamdataError.prototype,"isClient",StreamdataError.prototype.isClient);Exporter.a(StreamdataError.prototype,"getMessage",StreamdataError.prototype.getMessage);Exporter.a(StreamdataError.prototype,"getStatus",StreamdataError.prototype.getStatus);Exporter.a(StreamdataError.prototype,"getType",StreamdataError.prototype.getType);Exporter.a(StreamdataEventSource.prototype,"open",StreamdataEventSource.prototype.connect);Exporter.a(StreamdataEventSource.prototype,"onOpen",StreamdataEventSource.prototype.xa);
Exporter.a(StreamdataEventSource.prototype,"onError",StreamdataEventSource.prototype.va);Exporter.a(StreamdataEventSource.prototype,"onData",StreamdataEventSource.prototype.ua);Exporter.a(StreamdataEventSource.prototype,"onPatch",StreamdataEventSource.prototype.ya);Exporter.a(StreamdataEventSource.prototype,"onMonitor",StreamdataEventSource.prototype.wa);Exporter.a(StreamdataEventSource.prototype,"isConnected",StreamdataEventSource.prototype.qa);
